<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OneX Smart Gold (OSG) â€“ Staking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0b0b;
      color: #fff;
      text-align: center;
      padding: 30px;
    }
    .box {
      max-width: 420px;
      margin: auto;
      background: #151515;
      padding: 25px;
      border-radius: 14px;
    }
    button {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      background: gold;
      color: black;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-top: 6px;
    }
    .small {
      font-size: 13px;
      color: #aaa;
    }
  </style>
</head>

<body>
<div class="box">
  <h2>OneX Smart Gold (OSG)</h2>
  <p class="small">Official Staking Portal</p>

  <button onclick="connectWallet()">ðŸ”Œ Connect Wallet</button>
  <p id="walletStatus" class="small"></p>

  <hr>

  <p><b>OSG Balance:</b> <span id="tokenBalance">0</span></p>
  <p><b>Staked:</b> <span id="stakedBalance">0</span></p>

  <input id="stakeAmount" placeholder="Enter OSG amount to stake" />
  <button onclick="stake()">ðŸ“¥ Stake</button>
  <button onclick="unstake()">ðŸ“¤ Unstake</button>

  <hr>

  <div id="refBox" style="display:none;">
    <p><b>Your Referral Link</b></p>
    <input id="refLink" readonly />
    <button onclick="copyRef()">ðŸ“‹ Copy</button>
  </div>
</div>

<script>
// ===== CONFIG (CHECK CAREFULLY) =====
const OSG_TOKEN = "0x25c49541763b9Aa482a28E41b5a150CDa2E49a82";
const STAKING_CONTRACT = "0xa1D71A7459D757e6471ec7573867301A261504A4";

const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)",
  "function decimals() view returns (uint8)"
];

const STAKING_ABI = [
  "function stake(uint256,address)",
  "function unstake(uint256)",
  "function stakedBalance(address) view returns (uint256)"
];

let provider, signer, user, token, staking, decimals = 18;
let referrer = null;

// read referral
const params = new URLSearchParams(window.location.search);
if (params.get("ref")) referrer = params.get("ref");

async function connectWallet() {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  user = await signer.getAddress();

  const net = await provider.getNetwork();
  if (net.chainId !== 137) {
    alert("Switch to Polygon network");
    return;
  }

  token = new ethers.Contract(OSG_TOKEN, ERC20_ABI, signer);
  staking = new ethers.Contract(STAKING_CONTRACT, STAKING_ABI, signer);
  decimals = await token.decimals();

  document.getElementById("walletStatus").innerText =
    "Connected: " + user;

  const bal = await token.balanceOf(user);
  document.getElementById("tokenBalance").innerText =
    ethers.utils.formatUnits(bal, decimals);

  const staked = await staking.stakedBalance(user);
  document.getElementById("stakedBalance").innerText =
    ethers.utils.formatUnits(staked, decimals);

  const link =
    window.location.origin +
    window.location.pathname +
    "?ref=" +
    user;

  document.getElementById("refLink").value = link;
  document.getElementById("refBox").style.display = "block";
}

async function stake() {
  const amt = document.getElementById("stakeAmount").value;
  const value = ethers.utils.parseUnits(amt, decimals);

  await token.approve(STAKING_CONTRACT, value);
  await staking.stake(value, referrer ?? ethers.constants.AddressZero);

  alert("Stake submitted");
}

async function unstake() {
  const amt = document.getElementById("stakeAmount").value;
  const value = ethers.utils.parseUnits(amt, decimals);

  await staking.unstake(value);
  alert("Unstake submitted");
}

function copyRef() {
  document.getElementById("refLink").select();
  document.execCommand("copy");
  alert("Referral link copied");
}
</script>
</body>
</html>
